<!doctype html>
<html>
    <head>
        <meta http-equiv="Access-Control-Allow-Origin" content="*">
        <!-- <meta charset="utf-8"> -->
        <style>
        body {
        font: 10px sans-serif;
        shape-rendering: crispedges;
        }
        .axis path,
        .axis line {
            stroke: lightgrey;
            fill: none;
        }
        .grid .x.axis line {
            stroke: lightgrey;
        }
        .axis text,
        .legend {
            stroke: #E0E0EB;
            stroke-width: .3px;
        }        
        rect {
            fill-opacity: .55;
        }
        </style>
    </head>
    <body>
    <script src="libs/d3.v3.min.js"></script>

    <script>
        
    var margin = {top: 120, right: 20, bottom: 30, left: 190},
    width = 760 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom,

    legendPanel = {
            width: 240
    },    

    groups = {
      SD: "Senate Democrat",
      HD: "Democrat",
      SR: "Senate Republican",
      HR: "Republican"
    },

    colors = {
      SD: "#4D94DB",
      HD: "#0066CC",
      SR: "#E06666",
      HR: "#CC0000"
    },

    // color = d3.scale.ordinal()
    //     .domain([groups.SD, groups.HD, groups.SR, groups.HR])
    //     .range([colors.SD, colors.HD, colors.SR, colors.HR]);

    color = d3.scale.ordinal()
        .domain([groups.HD, groups.HR])
        .range([colors.HD, colors.HR]);

    breakdown_url = 'http://congress.api.sunlightfoundation.com/votes?vote_type=passage&result=Passed&fields=voted_at,chamber,bill_id,question,result,breakdown.party&apikey=2282ac571e0b46b69bb7879f4de9b158&per_page=50&page=1&query=';

    bills_url = 'http://congress.api.sunlightfoundation.com/bills?actions.result=pass&actions.type=vote&fields=sponsor.party,chamber,actions,official_title,short_title,popular_title,bill_id,history.vetoed,history.enacted,last_vote_at&apikey=2282ac571e0b46b69bb7879f4de9b158&per_page=50&page=1&keywords=';

    kword = ["Agriculture and food", "Animals", "Armed forces and national security", "Arts, culture, religion", "Civil rights and liberties, minority issues", "Commerce", "Congress", "Crime and law enforcement", "Economics and public finance", "Education", "Emergency management", "Energy", "Environmental protection", "Families", "Finance and financial sector", "Foreign trade and international finance", "Government operations and politics", "Immigration", "International affairs", "Labor and employment", "Law", "Native Americans", "Private legislation", "Public lands and natural resources", "Science, technology, communications", "Social sciences and history", "Social security and elderly assistance", "Social welfare", "Taxation"];

    var vetoed, enacted, passed, failed, dSponsor, rSponsor,iSponsor;
    var rawData = [];
    var aggData = [];
    var voteData = [];

    for (var i = 0; i < kword.length; i++) {

      (function(i) {

        d3.json(bills_url + kword[i], function(error, data) {
          if(error) return console.warn(error);

          var bills = [];
          
          incoming = data.results;
          incoming.forEach(function(d) { 

            var actions = d.actions;
            var result = -1;

            for(var j = 0; j < actions.length; j++) {
                if(actions[j].result !== undefined) {
                    result = actions[j].result;
                    break;
                }
            }

            try {

              if(d.bill_id !== undefined) {
                  bills.push({
                    "official_title": d.official_title, 
                    "short_title": d.short_title,
                    "popular_title":d.popular_title, 
                    "bill_id": d.bill_id, 
                    "result": result, 
                    "enacted": d.history.enacted, 
                    "vetoed": d.history.vetoed, 
                    "chamber": d.chamber, 
                    "last_vote": d.last_vote_at, 
                    "sponsor_party": d.sponsor.party
                  });
              
              }

            } catch (err) {
              console.log("Undefined attribute in bill:", d.bill_id);
            }

          });

          rawData.push({"keyword": kword[i], "details": bills}); 

          vetoed = enacted = passed = failed = rSponsor = dSponsor = iSponsor = 0;

          incoming = bills;
          incoming.forEach(function(b) {

            if (b.vetoed === true) {
              vetoed += 1;
            } else if (b.enacted === true) {
              enacted += 1;
            } 

            if (b.result == "pass") {
              passed += 1;
            } else if (b.result == "fail") {
              failed += 1;
            } 

            if (b.sponsor_party == "R") {
              rSponsor += 1;
            } else if (b.sponsor_party == "D") {
              dSponsor += 1;
            } else if (b.sponsor_party == "I") {
              iSponsor += 1;
            }
          });

          aggData.push({
            "keyword": kword[i], 
            "vetoed": vetoed, 
            "enacted": enacted, 
            "passed": passed, 
            "failed": failed, 
            "r_sponsor": rSponsor, 
            "d_sponsor": dSponsor, 
            "i_sponsor": iSponsor});
              
          if(aggData.length == kword.length) {
            
            var rset = [];
            var dset = [];
            var dataset = [];

            aggData.forEach(function(kw) {

              rset.push({"keyword": kw.keyword, "vote": kw.r_sponsor});
              dset.push({"keyword": kw.keyword, "vote": kw.d_sponsor});

            });
          
            dataset.push({"data":rset, "name": groups.HR});
            dataset.push({"data":dset, "name": groups.HD});

            series = dataset.map(function(d) { return d.name; });

            dataset = dataset.map(function(d) {
                return d.data.map(function(o, i) {
                    return {
                        x: o.keyword,
                        y: o.vote
                    };
                });
            });

            //use stack layout 
            stack = d3.layout.stack();
            stack(dataset);

            // console.log(dataset);

            dataset = dataset.map(function(group) {
                return group.map(function(d) {
                    // horizontal bars, invert the x and y values, and y0 becomes x0
                    return {
                        x: d.y,
                        y: d.x,
                        x0: d.y0
                    };
                });
            });

            // console.log("inverted dataset")
            // console.log(dataset);

            var svg = d3.select('body')
                .append('svg')
                    .attr('width', width + margin.left + margin.right + legendPanel.width)
                    .attr('height', height + margin.top + margin.bottom)
                .append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
                    .attr("class", "grid"),

            xMax = d3.max(dataset, function(group) {
                return d3.max(group, function(d) {
                    return d.x + d.x0;
                });
            }),
            
            xScale = d3.scale.linear()
                .domain([0, xMax])
                .range([0, width - margin.right]);

            keywords = dataset[0].map(function(d) { return d.y; });

            yScale = d3.scale.ordinal()
                .domain(keywords)
                .rangeRoundBands([0, height], 0.6);

            xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom');

            yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left');

            groups = svg.selectAll('g')
                .data(dataset)
                .enter()
                .append('g')
                .style('fill', function(d, i) {
                    return color(i);
                }),

            rects = groups.selectAll('rect')
                .data(function(d) { return d; })
                .enter()
                .append('rect')
                .attr('x', function(d) { return xScale(d.x0); })
                .attr('y', function(d, i) { return yScale(d.y); })
                .attr('height', function(d) { return yScale.rangeBand(); })
                .attr('width', function(d) { return xScale(d.x); });

            svg.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(0,' + height + ')')
                .call(xAxis)
                .append("text")
                .attr("x", width - 15)
                .attr("y", -20)
                .attr("dy", "1.7em")
                .style("text-anchor", "end")
                .text("Number of bills passed, by party");

            svg.append('g')
                .attr('class', 'y axis')
                .call(yAxis);

            svg.append('rect')
                .attr('fill', 'none')
                .attr('width', 160)
                .attr('height', 30 * dataset.length)
                .attr('x', width + margin.left)
                .attr('y', 0);

          var legend = svg.selectAll(".legend")
              .data(series) 
              .enter().append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

          legend.append("rect")
              .attr("x", width + 20)
              .attr("y", 22)
              .attr("width", 10)
              .attr("height", 10)
              .style("fill", color);

          legend.append("text")
              .attr("x", width + 35)
              .attr("y", 30)
              //.attr("dy", ".15em")
              .style("text-anchor", "start")
              .text(function(d) { return d; });
            
          }
                       
        });

      }) (i);
    }


</script>
</body>
</html>