<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Access-Control-Allow-Origin" content="*">
        <!-- <meta charset="utf-8"> -->
        <style>
        body {
          font: 12px Arial, Helvetica, sans-serif;
        }
        #control-menu {
          margin: 20px;
          font-size: 20px;
        }

        button {
            color: #fff;
            font-size: 16px;
            text-decoration: none;
            line-height: 20px;
            vertical-align: baseline;
            padding: 8px 16px;
            border:none;
            border-radius: 2px;
            margin: 0 10px;
            width: 120px;
        }

        .btn-red {
          background-color: #F8DEDE;
        }
        .btn-red:hover,
        .btn-red.active {
            background: #CC0000;
        }

        .btn-blue {
            background: #DDEAF8;
        }

        .btn-blue:hover,
        .btn-blue.active {
            background: #0066CC;
        }

        .btn-blend {
            background: #F5F5F1;
        }

        .btn-blend:hover,
        .btn-blend.active {
            background: #999966;
        }

        text,
        .tooltip,
        .note {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 9px;
        }
    
        .tooltip {
          opacity: 0.2;
        }

        .tooltip:hover {
          opacity: 1;
        }

        .link {
          stroke: #F0F0F5;
          stroke-width: 1.5px;
         }

        .axis line,
        .axis path {
            fill: none;
            stroke: #C0C0C0;
            shape-rendering: crispEdges;
        }

        .axis path,
        .axis line {
            stroke: lightgrey;
            fill: none;
        }
        .grid .x.axis line {
            stroke: lightgrey;
        }

        .axis text,
        .legend {
            stroke: #E0E0EB;
            stroke-width: .3px;
        }        

        .axis text {
            font: 12px sans-serif;
            fill: gray;
        }
    </style>

    <script src="libs/d3.v3.min.js"></script>
    <script src="libs/d3.layout.cloud.js"></script>
    <script src="libs/jquery.1.11.min.js"></script>

    </head>
    <body>

      <div id="control-menu">Visualize U.S. Politics - Legislative Bills in </div>

      <table>
        <tr>
            <td><div id="vis">
                <div id="medicare"></div>
                </div>
            </td>
            <td><div id="detail-vis"></div></td>
        </tr>
    </table>
    
    <script>
    d3.select("body div#control-menu").append("button")
      .text("Numbers") //stacked bar chart
      .attr("class", "btn-red")
      .on("click", function() {
            d3.select(this)
            .attr("class", "btn-red active"); 
            //deselect other buttons
            d3.select("#control-menu button.btn-blue").attr("class", "btn-blue");
            d3.select("#control-menu button.btn-blend").attr("class", "btn-blend");
            //hide other views
            if(d3.select("svg#word-view")) {d3.select("svg#word-view").remove()}
            if(d3.select("svg#force-view")) {d3.select("svg#force-view").remove()}
            if(d3.select("#detail-vis")) {d3.select("#detail-vis").style("display","none")}

            if(d3.select("#bar-view")) {d3.select("#bar-view").remove()} 

            barView();
        });

    d3.select("body div#control-menu").append("button")
      .text("Details")
      .attr("class", "btn-blue")
      .on({
        "click": function() {
            d3.select(this).attr("class", "btn-blue active"); 

            //deselect other buttons
            d3.select("#control-menu button.btn-red").attr("class", "btn-red");
            d3.select("#control-menu button.btn-blend").attr("class", "btn-blend");
            //delete other views
            if(d3.select("svg#bar-view")) {d3.select("svg#bar-view").remove()}
            if(d3.select("svg#word-view")) {d3.select("svg#word-view").remove()}

            //make detail vis area visible 
            if(d3.select("#detail-vis")) {d3.select("#detail-vis").style("display","block")}

            if(d3.select("#force-view")) {d3.select("#force-view").remove()} 

            forceView();
        }
    });  

    d3.select("body div#control-menu").append("button")
      .text("Topics")
      .attr("class", "btn-blend")
      .on({
        "click": function() {
            d3.select(this).attr("class", "btn-blend active"); 
            //deselect other buttons
            d3.select("#control-menu button.btn-red").attr("class", "btn-red");
            d3.select("#control-menu button.btn-blue").attr("class", "btn-blue");
            //hide other views
            if(d3.select("svg#bar-view")) {d3.select("svg#bar-view").remove()}
            if(d3.select("svg#force-view")) {d3.select("svg#force-view").remove()}
            if(d3.select("#detail-vis")) {d3.select("#detail-vis").style("display","none")}

            if(d3.select("#word-view")) {d3.select("#word-view").remove()}  

            wordView();
        }
    });   

var margin = {
    top: 50,
    right: 50,
    bottom: 50,
    left: 250
},
width = 760 - margin.left - margin.right,
height = 800 - margin.top - margin.bottom,
detailVisWidth = 350,
detailVisHeight = 350,

detailVis = d3.select("#detail-vis").append("svg").attr({
    width:detailVisWidth,
    height:detailVisHeight
}),

groups = {
  //SD: "Senate Democrat",
  HD: "Democrat",
  //SR: "Senate Republican",
  HR: "Republican"
},

colors = {
  //SD: "#4D94DB",
  HD: "#0066CC",
  //SR: "#E06666",
  HR: "#CC0000"
},

color = d3.scale.ordinal()
    .domain([groups.HD, groups.HR])
    .range([colors.HD, colors.HR]);

var barView = function() {

    var legendPanel = {
            width: 240
    },  

    breakdown_url = 'http://congress.api.sunlightfoundation.com/votes?vote_type=passage&result=Passed&fields=voted_at,chamber,bill_id,question,result,breakdown.party&apikey=2282ac571e0b46b69bb7879f4de9b158&per_page=50&page=1&query=';

    bills_url = 'http://congress.api.sunlightfoundation.com/bills?actions.result=pass&actions.type=vote&fields=sponsor.party,chamber,actions,official_title,short_title,popular_title,bill_id,history.vetoed,history.enacted,last_vote_at&apikey=2282ac571e0b46b69bb7879f4de9b158&per_page=50&page=1&keywords=';

    kword = ["Agriculture and food", "Animals", "Armed forces and national security", "Arts, culture, religion", "Civil rights and liberties, minority issues", "Commerce", "Congress", "Crime and law enforcement", "Economics and public finance", "Education", "Emergency management", "Energy", "Environmental protection", "Families", "Finance and financial sector", "Foreign trade and international finance", "Government operations and politics", "Immigration", "International affairs", "Labor and employment", "Law", "Native Americans", "Private legislation", "Public lands and natural resources", "Science, technology, communications", "Social sciences and history", "Social security and elderly assistance", "Social welfare", "Taxation"];

    var vetoed, enacted, passed, failed, dSponsor, rSponsor,iSponsor;
    var rawData = [];
    var aggData = [];
    var voteData = [];

    for (var i = 0; i < kword.length; i++) {

      (function(i) {

        d3.json(bills_url + kword[i], function(error, data) {
          if(error) return console.warn(error);

          var bills = [];
          
          incoming = data.results;
          incoming.forEach(function(d) { 

            var actions = d.actions;
            var result = -1;

            for(var j = 0; j < actions.length; j++) {
                if(actions[j].result !== undefined) {
                    result = actions[j].result;
                    break;
                }
            }

            try {

              if(d.bill_id !== undefined) {
                  bills.push({
                    "official_title": d.official_title, 
                    "short_title": d.short_title,
                    "popular_title":d.popular_title, 
                    "bill_id": d.bill_id, 
                    "result": result, 
                    "enacted": d.history.enacted, 
                    "vetoed": d.history.vetoed, 
                    "chamber": d.chamber, 
                    "last_vote": d.last_vote_at, 
                    "sponsor_party": d.sponsor.party
                  });
              
              }

            } catch (err) {
              console.log("Undefined attribute in bill:", d.bill_id);
            }

          });

          rawData.push({"keyword": kword[i], "details": bills}); 

          vetoed = enacted = passed = failed = rSponsor = dSponsor = iSponsor = 0;

          incoming = bills;
          incoming.forEach(function(b) {

            if (b.vetoed === true) {
              vetoed += 1;
            } else if (b.enacted === true) {
              enacted += 1;
            } 

            if (b.result == "pass") {
              passed += 1;
            } else if (b.result == "fail") {
              failed += 1;
            } 

            if (b.sponsor_party == "R") {
              rSponsor += 1;
            } else if (b.sponsor_party == "D") {
              dSponsor += 1;
            } else if (b.sponsor_party == "I") {
              iSponsor += 1;
            }
          });

          aggData.push({
            "keyword": kword[i], 
            "vetoed": vetoed, 
            "enacted": enacted, 
            "passed": passed, 
            "failed": failed, 
            "r_sponsor": rSponsor, 
            "d_sponsor": dSponsor, 
            "i_sponsor": iSponsor});
              
          if(aggData.length == kword.length) {
            
            var rset = [];
            var dset = [];
            var dataset = [];

            aggData.forEach(function(kw) {

              rset.push({"keyword": kw.keyword, "vote": kw.r_sponsor});
              dset.push({"keyword": kw.keyword, "vote": kw.d_sponsor});

            });
          
            dataset.push({"data":rset, "name": groups.HR});
            dataset.push({"data":dset, "name": groups.HD});

            series = dataset.map(function(d) { return d.name; });

            dataset = dataset.map(function(d) {
                return d.data.map(function(o, i) {
                    return {
                        x: o.keyword,
                        y: o.vote
                    };
                });
            });

            //use stack layout 
            stack = d3.layout.stack();
            stack(dataset);

            // console.log(dataset);

            dataset = dataset.map(function(group) {
                return group.map(function(d) {
                    // horizontal bars, invert the x and y values, and y0 becomes x0
                    return {
                        x: d.y,
                        y: d.x,
                        x0: d.y0
                    };
                });
            });

            // console.log("inverted dataset")
            // console.log(dataset);

            var svg = d3.select('body')
                .append('svg')
                    .attr("id", "bar-view")
                    .attr('width', width + margin.left + margin.right + legendPanel.width)
                    .attr('height', height + margin.top + margin.bottom)
                .append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
                    .attr("class", "grid")
                    .text("BAR VIEW"),

            xMax = d3.max(dataset, function(group) {
                return d3.max(group, function(d) {
                    return d.x + d.x0;
                });
            }),
            
            xScale = d3.scale.linear()
                .domain([0, xMax])
                .range([0, width - margin.right]);

            keywords = dataset[0].map(function(d) { return d.y; });

            yScale = d3.scale.ordinal()
                .domain(keywords)
                .rangeRoundBands([0, height], 0.6);

            xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom');

            yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left');

            groups = svg.selectAll('g')
                .data(dataset)
                .enter()
                .append('g')
                .style('fill', function(d, i) {
                    return color(i);
                }),

            rects = groups.selectAll('rect')
                .data(function(d) { return d; })
                .enter()
                .append('rect')
                .attr('x', function(d) { return xScale(d.x0); })
                .attr('y', function(d, i) { return yScale(d.y); })
                .attr('height', function(d) { return yScale.rangeBand(); })
                .attr('width', function(d) { return xScale(d.x); });

            svg.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(0,' + height + ')')
                .call(xAxis)
                .append("text")
                .attr("x", width - 15)
                .attr("y", -20)
                .attr("dy", "1.7em")
                .style("text-anchor", "end")
                .text("Number of bills passed, by party");

            svg.append('g')
                .attr('class', 'y axis')
                .call(yAxis);

            svg.append('rect')
                .attr('fill', 'none')
                .attr('width', 160)
                .attr('height', 30 * dataset.length)
                .attr('x', width + margin.left)
                .attr('y', 0);

          var legend = svg.selectAll(".legend")
              .data(series) 
              .enter().append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

          legend.append("rect")
              .attr("x", width + 20)
              .attr("y", 22)
              .attr("width", 10)
              .attr("height", 10)
              .style("fill", color);

          legend.append("text")
              .attr("x", width + 35)
              .attr("y", 30)
              //.attr("dy", ".15em")
              .style("text-anchor", "start")
              .text(function(d) { return d; });

/*
          groups.append("text")
            .attr("x", width/6)
            .attr("y", -10)
            .text("A Look into Successful Federal Legislation")
            .style("font-size", "20px")
            .style("fill", "#686868");    
*/        
          }
        });

      }) (i);
    }
} //end barView

var wordView = function() {

  var wordsStr = "";
  var words = {};

  d3.json("data-test/sunlight-votes-2014.json", function(data) {
      $.each(data.results, function(j, vote){
        wordsStr += vote.question;  
    })

    words = countWords(wordsStr); 

    d3.layout.cloud().size([300, 300])
      .words(words)
      .rotate(0)
      .fontSize(function(d) { return d.size * 8; })
      .on("end", drawWords)
      .start();

  });

} //end wordView

function countWords (d) {
  var wordsStr = d; 
  var ignore = ['and','the','to','a','of','for','as','i','with','it','is','on','that','this','can','in','be','has','if', '--', 'act', 'or', 'table', 'other', 'res', 'passage', 'bill', 'amend', 'agreeing', 'any', 'by', 'motion', 'law', 'use', 'amdt', 'xviii', 'improve', 'instructions','consideration', 'sgr', 'question','recommit','agreement','observe','repeal','conditioning','resolution','ordering','title','houseon','executive','nomination','right','rights','execution','secretaries', 'needs','rate','congressional','states', 'pn', 'enactments', 'previous', 'block', 'provider', 'providing','amendment','purposeson'];

  wordsArray = wordsStr.toLowerCase().replace(/[^a-z\-]/g," ").split(" "); //remove non characters, split by empty space 
  counts={}
  for( i in wordsArray) {
    if(wordsArray[i].length > 1 && $.inArray(wordsArray[i], ignore) < 0) 
      counts[wordsArray[i]] ? counts[wordsArray[i]]+=1 : counts[wordsArray[i]]=1;
  }
  var words = [];
  for (var i in counts) { words.push({"text": i, "size": counts[i]})}
  words.sort(function(a, b) {return b.size - a.size})
  //console.log(words)
  return words;
}

function drawWords(words) {
  var fill = d3.scale.category20();

  d3.select("body").append("svg")
      .attr("id", "word-view")
      .attr("width", 300)
      .attr("height", 300)
    .append("g")
      .attr("transform", "translate(150,150)")
    .selectAll("text")
      .data(words)
    .enter().append("text")
      .style("font-size", function(d) { return d.size + "px"; })
      .style("font-family", "arial")
      .style("fill", function(d, i) { return fill(i); })
      .attr("text-anchor", "middle")
      .attr("transform", function(d) {
        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
      })
      .text(function(d) { return d.text; });
}

var forceView = function() {

  d3.json("data-test/votes-medicare-test.json", function(data) {
    var graph = {nodes:[], links:[]};
    var subjectNode = {
        "bill_id": "Medicare"
    }
    graph.nodes = data.results;

    for(j = 0; j < graph.nodes.length; j++) {
          graph.links.push({"source": 0, "target": j}); //links from one node, simplifies the subject, not actual votes on the subject
    }

    graph.nodes.unshift(subjectNode);

    //console.log(graph.nodes);
    //console.log(graph.links);

    var canvas = d3.select("#vis #medicare").append("svg")
        .attr("id", "force-view")
        .attr({
          width: width + margin.left + margin.right,
          height: height + margin.top + margin.bottom
        });

        svg = canvas.append("g").attr({
            transform: "translate(" + margin.left + "," + margin.top + ")"
        }),

    force = d3.layout.force()
        .size([width, height])
        .charge(-50)
        .linkDistance(100)
        .on("tick", function(d){
          link.transition().duration(0)
          .attr("x1", function(d) { return d.target.x; })
          .attr("y1", function(d) { return d.target.y; })
          .attr("x2", function(d) { return d.source.x; })
          .attr("y2", function(d) { return d.source.y; });

          node.transition().duration(0)
            .attr("transform", function(d) { 
            return "translate("+d.x+","+d.y+")"; 
          });
        })
        .on("start", function(d) {})
        .on("end", function(d) {})

    var link = svg.selectAll(".link")
                  .data(graph.links)
                  .enter().append("line")
                  .attr("class", "link");

    var node = svg.selectAll(".node")
                  .data(graph.nodes)
                  .enter()
                  .append("g").attr("class", "node")
                  .on("click", function(d){
                    createDetailVis(d);
                  });

    node.append("circle")
        .attr("r", 5)
        .style("fill", function(d) { 
          if(d.bill_id == "Medicare") return "#F0F0F5" ; //this is the fake node representing the subject
          
          var p= d.party;
          var clr; 
          if(p == "R") clr = groups.HR;
          else if(p == "D") clr = groups.HD;

          return color(clr); 
        });

    node.append("svg:text")
            .attr("class", "tooltip")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(function(d) { return d.bill_id });


    force.nodes(graph.nodes)
          .links(graph.links)
          .start();
  })
} //end forceView 

var createDetailVis = function(data){
  var voteDetail = "Vote question: <br/>" + data.question + "<br/><br/>" 
                + "Vote ID: <br/>" + data.bill_id + "<br/><br/>"
                + "Voted Year: <br/>" + data.year + "<br/><br/>"
                + "Result: <br/>" + data.result + "<br/><br/>"
                + "Source: <br/>" + data.source;

  // clean the previous graph first
  detailVis.select("g.note").remove();

  // draw the new vis 
  var svgDetail = detailVis.append("g")
    .attr("class", "note")
    .attr('transform', 'translate(' + 30 + ', ' + 30 + ')');

  var rect = svgDetail.append('rect')
                        .attr('width', 350)
                        .attr('height', 500)
                        .attr('x', 0)
                        .attr('y', 0)
                        .style('fill', '#F0F0F5')

        text = svgDetail.append('foreignObject')
                        .attr('x', 0)
                        .attr('y', 0)
                        .attr('width', 330)
                        .attr('height', 500)
                        .append("xhtml:body")
                        .html(voteDetail);
}
</script>
</body>
</html>